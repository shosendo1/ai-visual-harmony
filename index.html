<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIビジュアルハーモニー・プラス</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .btn-primary {
            background-color: #3B82F6; color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #2563EB; }
        .btn-primary:disabled { background-color: #93C5FD; cursor: not-allowed; }
        
        .btn-secondary {
            background-color: #ffffff; color: #1E40AF; border: 1px solid #93C5FD;
            transition: all 0.3s;
        }
        .btn-secondary:hover { background-color: #EFF6FF; border-color: #60A5FA; }
        .btn-secondary:disabled {
            background-color: #EFF6FF;
            color: #93C5FD;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .step-icon { background-color: #3B82F6; }
        .preset-btn.selected, .effect-btn.selected, .placement-btn.selected, .angle-btn.selected, .brightness-btn.selected {
            background-color: #DBEAFE; border-color: #60A5FA;
            color: #1E40AF; font-weight: 600;
        }
        /* MyRoom Mode Styles */
        .dropzone { border: 2px dashed #9fa8da; }
        .dropzone.dragover { background-color: #e8eaf6; border-style: solid; }
        #mr-composition-area { position: relative; width: 100%; overflow: hidden; background-color: #e0e0e0; user-select: none; }
        #mr-room-photo-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        #mr-artwork-container { position: absolute; top: 30%; left: 30%; width: 40%; height: 40%; border: 2px dashed rgba(0, 0, 0, 0.5); cursor: move; }
        #mr-artwork-img { width: 100%; height: 100%; object-fit: contain; }
        .mr-resize-handle { position: absolute; width: 14px; height: 14px; background-color: rgba(255, 255, 255, 0.9); border: 2px solid #3B82F6; border-radius: 50%; }
        .mr-resize-handle.br { bottom: -7px; right: -7px; cursor: se-resize; }
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="app-container" class="container mx-auto px-4 py-6 sm:px-6 md:px-8 max-w-4xl">
        
        <!-- ======================= -->
        <!--      START SCREEN       -->
        <!-- ======================= -->
        <div id="start-screen">
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">AIビジュアルハーモニー・プラス</h1>
                <p class="mt-3 text-gray-600">2つのシミュレーション機能で、あなたの作品がもっと輝く空間を見つけましょう。</p>
            </header>
            <main class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 sm:p-8 space-y-6">
                <h2 class="text-xl font-bold text-gray-800 text-center">どちらの機能を使いますか？</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Mode A: AI Generate -->
                    <button id="start-vh-mode-btn" class="text-left p-6 border rounded-lg hover:shadow-lg transition">
                         <h3 class="text-lg font-bold text-blue-800">AIに理想の背景を生成させる</h3>
                         <p class="mt-2 text-sm text-gray-600">スタイルや雰囲気を指示して、AIが作り出す架空の美しい空間に作品を飾ります。新しいインスピレーションを見つけたい場合に最適です。</p>
                    </button>
                    <!-- Mode B: My Room Composite -->
                     <button id="start-mr-mode-btn" class="text-left p-6 border rounded-lg hover:shadow-lg transition">
                         <h3 class="text-lg font-bold text-blue-800">ご自身の部屋の写真に合成する</h3>
                         <p class="mt-2 text-sm text-gray-600">お手持ちの部屋の写真に作品を合成し、サイズや位置を調整します。購入前のリアルなシミュレーションに最適です。</p>
                    </button>
                </div>
            </main>
        </div>

        <!-- ============================= -->
        <!--  AI VISUAL HARMONY MODE (VH)  -->
        <!-- ============================= -->
        <div id="visual-harmony-mode" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">AIビジュアルハーモニー</h1>
                <p class="mt-2 text-gray-600">AIに理想の背景を生成させます。</p>
            </header>

            <main class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 sm:p-6 md:p-8 space-y-8">
                <!-- VH Step 1 -->
                <div id="vh-step1" class="flex flex-col md:flex-row items-start md:space-x-4">
                     <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0 mb-4 md:mb-0">1</div>
                     <div class="w-full">
                         <h2 class="text-xl font-bold text-gray-700">掛け軸画像をアップロード</h2>
                         <div id="vh-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 transition mt-4">
                            <input type="file" id="vh-imageUpload" class="hidden" accept="image/png, image/jpeg">
                            <p id="vh-dropzone-text">クリックしてファイルを選択<br>またはドラッグ＆ドロップ</p>
                            <img id="vh-preview" class="hidden max-h-40 mx-auto mt-4 rounded">
                        </div>
                        <div id="vh-placement-selection" class="mt-4 opacity-50 pointer-events-none">
                            <p class="text-sm text-gray-600 mb-2 font-semibold">飾る場所を選択してください:</p>
                            <div class="grid grid-cols-2 gap-2">
                                 <button data-placement="tokonoma" class="placement-btn flex-1 p-2 text-sm border rounded-lg transition selected">床の間</button>
                                 <button data-placement="hekimen" class="placement-btn flex-1 p-2 text-sm border rounded-lg transition">壁面</button>
                            </div>
                        </div>
                     </div>
                </div>
                <!-- VH Step 2 -->
                <div id="vh-step2" class="flex flex-col md:flex-row items-start md:space-x-4 opacity-50 pointer-events-none">
                     <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0 mb-4 md:mb-0">2</div>
                     <div class="w-full">
                        <h2 class="text-xl font-bold text-gray-700">背景のスタイルを指示</h2>
                        <textarea id="vh-prompt" class="w-full p-3 mt-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition" rows="3" placeholder="プリセットを選択するか、直接入力してください"></textarea>
                        
                        <div class="mt-6 space-y-6">
                            <!-- Preset categories -->
                            <div>
                                <p class="text-sm text-gray-600 mb-2 font-semibold">部屋の種類で選ぶ:</p>
                                <div class="flex flex-wrap gap-2">
                                <button data-prompt="和室" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">和室</button>
                                <button data-prompt="リビングルーム" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">リビングルーム</button>
                                <button data-prompt="茶室" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">茶室</button>
                                <button data-prompt="玄関" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">玄関</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2 font-semibold">空間の雰囲気で選ぶ:</p>
                                <div class="flex flex-wrap gap-2">
                                <button data-prompt="モダン和風" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">モダン和風</button>
                                <button data-prompt="町屋風" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">町屋風</button>
                                <button data-prompt="古民家風" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">古民家風</button>
                                <button data-prompt="ホテルライク" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">ホテルライク</button>
                                <button data-prompt="北欧風" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">北欧風</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2 font-semibold">壁の素材感で選ぶ:</p>
                                <div class="flex flex-wrap gap-2">
                                <button data-prompt="土壁" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">土壁</button>
                                <button data-prompt="漆喰壁" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">漆喰壁</button>
                                <button data-prompt="コンクリート壁" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">コンクリート壁</button>
                                <button data-prompt="和紙貼りの壁" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">和紙貼</button>
                                <button data-prompt="クロス貼りの壁" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">クロス貼</button>
                                <button data-prompt="唐紙の壁" class="preset-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">唐紙</button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 space-y-4">
                            <!-- Adjustment categories -->
                            <div>
                                <p class="text-sm text-gray-600 mb-2 font-semibold">効果を追加:</p>
                                <div class="flex flex-wrap gap-2">
                                    <button data-prompt="古い感じ、経年変化した、アンティーク" class="effect-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">古い感じにする</button>
                                    <button data-prompt="新しい、新品、モダン、クリーン" class="effect-btn p-2 text-xs border rounded-full transition hover:bg-gray-100">新しい感じにする</button>
                                </div>
                            </div>
                             <div>
                                <p class="text-sm text-gray-600 mb-2 font-semibold">画角の調整:</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <button data-angle="wide" class="angle-btn flex-1 p-2 text-sm border rounded-lg transition">広角</button>
                                    <button data-angle="normal" class="angle-btn flex-1 p-2 text-sm border rounded-lg transition selected">標準</button>
                                    <button data-angle="focus" class="angle-btn flex-1 p-2 text-sm border rounded-lg transition">フォーカス</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-2 font-semibold">明るさの調整:</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <button data-brightness="dark" class="brightness-btn flex-1 p-2 text-sm border rounded-lg transition">暗くする</button>
                                    <button data-brightness="normal" class="brightness-btn flex-1 p-2 text-sm border rounded-lg transition selected">標準</button>
                                    <button data-brightness="light" class="brightness-btn flex-1 p-2 text-sm border rounded-lg transition">明るくする</button>
                                </div>
                            </div>
                        </div>
                        <button id="vh-generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-105" disabled>画像を生成する</button>
                     </div>
                </div>
                <!-- VH Step 3 -->
                 <div id="vh-step3" class="flex flex-col md:flex-row items-start md:space-x-4 hidden">
                    <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0 mb-4 md:mb-0">3</div>
                    <div class="w-full">
                        <h2 class="text-xl font-bold text-gray-700">生成結果</h2>
                        <div id="vh-result-container" class="mt-4 min-h-[200px] bg-gray-100 rounded-lg flex items-center justify-center p-4">
                            <div id="vh-loading" class="text-center hidden">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4 text-gray-600">AIが最高の背景を考えています...<br>しばらくお待ちください。</p>
                            </div>
                            <img id="vh-resultImage" class="hidden max-w-full max-h-96 rounded-md">
                            <p id="vh-error-message" class="text-red-500 hidden"></p>
                        </div>
                         <button id="vh-saveBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-105 hidden">画像を保存する</button>
                    </div>
                </div>
                <button class="back-to-start-btn w-full text-center py-3 px-4 rounded-lg mt-4 hover:bg-gray-100">← モード選択に戻る</button>
            </main>
             <footer class="text-center mt-8 text-sm text-gray-500">
                <p>&copy; 2025 京表具 尚仙堂 All rights reserved.</p>
            </footer>
        </div>

        <!-- ============================= -->
        <!--    MY ROOM SIMULATOR MODE     -->
        <!-- ============================= -->
        <div id="my-room-mode" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">マイルーム・シミュレーター</h1>
                <p class="mt-2 text-gray-600">ご自身の部屋の写真に、作品を合成して飾ってみましょう。</p>
            </header>

            <main class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
                <!-- MR Step 1 -->
                <section id="mr-step1" class="flex items-start space-x-4">
                    <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">1</div>
                    <div class="w-full">
                        <h2 class="text-xl font-bold text-gray-700">作品画像をアップロード</h2>
                        <div id="mr-artwork-dropzone" class="dropzone rounded-lg p-6 text-center cursor-pointer mt-4">
                            <input type="file" id="mr-artwork-upload" class="hidden" accept="image/*">
                            <p id="mr-artwork-dropzone-text">クリックして作品を選択<br>またはドラッグ＆ドロップ</p>
                            <img id="mr-artwork-preview" class="hidden max-h-32 mx-auto mt-4 rounded">
                        </div>
                        <div id="mr-artwork-tools" class="mt-4 text-center hidden">
                            <button id="mr-remove-bg-btn" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-lg inline-flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic mr-2" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 0 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4L8 3.293a.5.5 0 0 0-.707-.707L6.586 3.586a.5.5 0 0 0 .707.707ZM5 6.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm-.5 3.915a.5.5 0 1 0 1 0v-1.83a.5.5 0 1 0-1 0v1.83Zm1.83-1.082a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1ZM10.5 13.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm-3.5-.035a.5.5 0 0 1 .707-.707l1.147 1.147a.5.5 0 0 1-.707.707L6.293 13.5l.707-.707ZM12.707 9.5a.5.5 0 1 1 0 1 .5.5 0 0 1 0-1ZM8.5 4.5a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0ZM14.5 6h-1.829a.5.5 0 1 0 0 1H14.5a.5.5 0 0 0 0-1ZM2.373 9.5a.5.5 0 1 0-1 0v.843a.5.5 0 1 0 1 0V9.5Zm1.829 1.082a.5.5 0 1 0 0 1H.843a.5.5 0 0 0 0-1h1.359Z"/></svg>
                                背景を自動で切り抜く
                            </button>
                            <p id="mr-status-message" class="text-sm text-center mt-2 h-4"></p>
                        </div>
                    </div>
                </section>
                <!-- MR Step 2 -->
                <section id="mr-step2" class="flex items-start space-x-4 opacity-50 pointer-events-none">
                    <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">2</div>
                    <div class="w-full">
                        <h2 class="text-xl font-bold text-gray-700">お部屋の写真をアップロード</h2>
                        <div id="mr-room-dropzone" class="dropzone rounded-lg p-6 text-center cursor-pointer mt-4">
                            <input type="file" id="mr-room-upload" class="hidden" accept="image/*">
                            <p id="mr-room-dropzone-text">クリックしてお部屋の写真を選択<br>またはドラッグ＆ドロップ</p>
                            <img id="mr-room-preview" class="hidden max-h-32 mx-auto mt-4 rounded">
                        </div>
                    </div>
                </section>
                <!-- MR Step 3 -->
                <section id="mr-step3" class="hidden">
                    <div class="flex items-start space-x-4">
                        <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">3</div>
                        <div class="w-full">
                            <h2 class="text-xl font-bold text-gray-700">合成と調整</h2>
                            <p class="text-sm text-gray-500 mb-4">作品をドラッグして移動、右下の●をドラッグしてサイズを変更できます。</p>
                            <div id="mr-composition-area" class="rounded-lg">
                                <img id="mr-room-photo-bg" src="">
                                <div id="mr-artwork-container">
                                    <img id="mr-artwork-img" src="">
                                    <div class="mr-resize-handle br"></div>
                                </div>
                            </div>
                            <button id="mr-generate-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6">これで生成</button>
                            <button class="back-to-start-btn w-full text-center py-3 px-4 rounded-lg mt-2 hover:bg-gray-100">← モード選択に戻る</button>
                        </div>
                    </div>
                </section>
                <!-- MR Step 4 -->
                 <section id="mr-step4" class="hidden">
                    <div class="flex items-start space-x-4">
                        <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">4</div>
                        <div class="w-full">
                            <h2 class="text-xl font-bold text-gray-700">完成</h2>
                            <p class="text-sm text-gray-500 mb-4">生成された合成画像です。</p>
                            <div id="mr-result-container" class="rounded-lg bg-gray-200">
                                 <img id="mr-result-image" class="w-full h-auto">
                            </div>
                            <button id="mr-save-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6">合成した画像を保存</button>
                            <button id="mr-back-btn" class="w-full text-center py-3 px-4 rounded-lg mt-2 hover:bg-gray-100">調整に戻る</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global Elements & State ---
        const startScreen = document.getElementById('start-screen');
        const vhMode = document.getElementById('visual-harmony-mode');
        const mrMode = document.getElementById('my-room-mode');
        const startVhModeBtn = document.getElementById('start-vh-mode-btn');
        const startMrModeBtn = document.getElementById('start-mr-mode-btn');
        const backToStartBtns = document.querySelectorAll('.back-to-start-btn');

        startVhModeBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            vhMode.classList.remove('hidden');
        });
        startMrModeBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            mrMode.classList.remove('hidden');
        });
        backToStartBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                 location.reload(); // Simple way to reset everything
            });
        });

        // ===========================================
        //  AI VISUAL HARMONY (VH) MODE JAVASCRIPT
        // ===========================================
        {
            const dropzone = document.getElementById('vh-dropzone');
            const imageUpload = document.getElementById('vh-imageUpload');
            const preview = document.getElementById('vh-preview');
            const dropzoneText = document.getElementById('vh-dropzone-text');
            const promptInput = document.getElementById('vh-prompt');
            const generateBtn = document.getElementById('vh-generateBtn');
            const loading = document.getElementById('vh-loading');
            const resultImage = document.getElementById('vh-resultImage');
            const errorMessage = document.getElementById('vh-error-message');
            const step2 = document.getElementById('vh-step2');
            const step3 = document.getElementById('vh-step3');
            const saveBtn = document.getElementById('vh-saveBtn');
            const placementSelection = document.getElementById('vh-placement-selection');

            let uploadedImageBase64 = '';
            let selectedBrightness = 'normal';
            let selectedPlacement = 'tokonoma';
            let selectedAngle = 'normal';

            dropzone.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleFile);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropzone.addEventListener(eName, preventDefaults));
            ['dragenter', 'dragover'].forEach(eName => dropzone.addEventListener(eName, () => dropzone.classList.add('bg-gray-100')));
            ['dragleave', 'drop'].forEach(eName => dropzone.addEventListener(eName, () => dropzone.classList.remove('bg-gray-100')));
            dropzone.addEventListener('drop', handleDrop);
            promptInput.addEventListener('input', updatePromptFromText);
            generateBtn.addEventListener('click', generateImage);
            saveBtn.addEventListener('click', saveImage);

            document.querySelectorAll('#visual-harmony-mode .placement-btn').forEach(btn => btn.addEventListener('click', (e) => handleSelection(e, 'placement')));
            document.querySelectorAll('#visual-harmony-mode .angle-btn').forEach(btn => btn.addEventListener('click', (e) => handleSelection(e, 'angle')));
            document.querySelectorAll('#visual-harmony-mode .brightness-btn').forEach(btn => btn.addEventListener('click', (e) => handleSelection(e, 'brightness')));
            document.querySelectorAll('#visual-harmony-mode .preset-btn, #visual-harmony-mode .effect-btn').forEach(btn => btn.addEventListener('click', handleMultiSelection));

            function handleSelection(e, type) {
                const button = e.currentTarget;
                const value = button.dataset[type];
                if (type === 'placement') selectedPlacement = value;
                if (type === 'angle') selectedAngle = value;
                if (type === 'brightness') selectedBrightness = value;
                
                document.querySelectorAll(`#visual-harmony-mode .${type}-btn`).forEach(b => b.classList.remove('selected'));
                button.classList.add('selected');
            }
            
            function handleMultiSelection(e) {
                e.currentTarget.classList.toggle('selected');
                updateTextFromButtons();
            }

            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            function handleDrop(e) { handleFile({ target: { files: e.dataTransfer.files } }); }

            function updateTextFromButtons() {
                const selectedPrompts = [];
                document.querySelectorAll('#visual-harmony-mode .preset-btn.selected, #visual-harmony-mode .effect-btn.selected').forEach(b => {
                    selectedPrompts.push(b.dataset.prompt);
                });
                promptInput.value = selectedPrompts.join(', ');
                updateGenerateBtnState();
            }

            function updatePromptFromText() {
                const textPrompts = new Set(promptInput.value.split(',').map(p => p.trim()).filter(Boolean));
                document.querySelectorAll('#visual-harmony-mode .preset-btn, #visual-harmony-mode .effect-btn').forEach(btn => {
                    btn.classList.toggle('selected', textPrompts.has(btn.dataset.prompt));
                });
                updateGenerateBtnState();
            }

            function updateGenerateBtnState() {
                generateBtn.disabled = !(promptInput.value.trim() && uploadedImageBase64);
            }

            function handleFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedImageBase64 = event.target.result.split(',')[1];
                    preview.src = event.target.result;
                    preview.classList.remove('hidden');
                    dropzoneText.classList.add('hidden');
                    placementSelection.classList.remove('opacity-50', 'pointer-events-none');
                    step2.classList.remove('opacity-50', 'pointer-events-none');
                    updateGenerateBtnState();
                };
                reader.readAsDataURL(file);
            }
            
            async function generateImage() {
                step3.classList.remove('hidden');
                loading.classList.remove('hidden');
                resultImage.classList.add('hidden');
                errorMessage.classList.add('hidden');
                saveBtn.classList.add('hidden');
                generateBtn.disabled = true;
                generateBtn.textContent = '生成中...';
                
                let userStyle = promptInput.value.trim();
                const absoluteRule = "【最重要・絶対厳守】これは、これから作品を飾るための、完全に『空っぽの背景』の画像です。この画像には、アート作品（掛け軸、額、絵画、屏風、ポスターなど）や、視線を奪うような主要な装飾品（花瓶、家具など）を一切含んではいけません。これはシミュレーション用の、何もない無人の背景です。";
                let primarySubject = (selectedPlacement === 'tokonoma')
                    ? "掛け軸を飾るための、がらんどうの『床の間』だけの建築写真。"
                    : "掛け軸を飾るための、何もない『壁』だけの建築写真。";

                const styleContext = `その壁や床の質感、素材、光の当たり方は、「${userStyle}」というスタイルを反映してください。ただし、そのスタイルに関連するオブジェクトは一切追加しないでください。`;
                let finalPrompt = `${primarySubject} ${styleContext} ${absoluteRule}`;
                
                if (selectedAngle === 'wide') finalPrompt += " 広角レンズでの撮影、ワイドショット。";
                if (selectedAngle === 'focus') finalPrompt += " クローズアップショット、背景をぼかす、被写界深度。";
                if (selectedBrightness === 'dark') finalPrompt += " 全体を薄暗く、落ち着いた雰囲気で、影を強調してください。";
                if (selectedBrightness === 'light') finalPrompt += " 全体を明るく、自然光が差し込む雰囲気で、鮮やかにしてください。";
                
                try {
                    const response = await fetch('https://ai-visual-harmony.netlify.app/.netlify/functions/generate', {
                        method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: finalPrompt, image: uploadedImageBase64 })
                    });
                    if (!response.ok) {
                        let errorText = `サーバーエラー: ${response.status}`;
                        try { 
                            const errorData = await response.json();
                             if (errorData.error && errorData.error.includes("API key not valid")) {
                                errorText = "Google APIで認証エラーが発生しました。<br>お手数ですが、以下の2点をご確認ください。<br>1. Netlifyの管理画面に設定したAPIキーが正しいか。<br>2. APIキーに紐付くGoogle Cloudプロジェクトの請求設定が有効になっているか。";
                            } else {
                                errorText = errorData.error || errorText;
                            }
                        } catch (e) {}
                        throw new Error(errorText);
                    }
                    const data = await response.json();
                    if (data.base64) {
                        resultImage.src = `data:image/png;base64,${data.base64}`;
                        resultImage.classList.remove('hidden');
                        saveBtn.classList.remove('hidden');
                    } else { throw new Error('画像データが返されませんでした。'); }
                } catch (error) {
                    console.error("VH Error:", error);
                    errorMessage.innerHTML = `エラー:<br>${error.message}`;
                    errorMessage.classList.remove('hidden');
                } finally {
                    loading.classList.add('hidden');
                    generateBtn.disabled = false;
                    generateBtn.textContent = '画像を生成する';
                }
            }
            
            function saveImage() {
                const link = document.createElement('a');
                link.href = resultImage.src;
                link.download = 'ai-visual-harmony-result.png';
                link.click();
            }
        }

        // ===========================================
        //     MY ROOM (MR) MODE JAVASCRIPT
        // ===========================================
        {
            const artworkDropzone = document.getElementById('mr-artwork-dropzone');
            const artworkUpload = document.getElementById('mr-artwork-upload');
            const artworkPreview = document.getElementById('mr-artwork-preview');
            const artworkDropzoneText = document.getElementById('mr-artwork-dropzone-text');
            const artworkTools = document.getElementById('mr-artwork-tools');
            const removeBgBtn = document.getElementById('mr-remove-bg-btn');
            const statusMessage = document.getElementById('mr-status-message');

            const roomDropzone = document.getElementById('mr-room-dropzone');
            const roomUpload = document.getElementById('mr-room-upload');
            const roomPreview = document.getElementById('mr-room-preview');
            const roomDropzoneText = document.getElementById('mr-room-dropzone-text');
            
            const compositionArea = document.getElementById('mr-composition-area');
            const roomPhotoBg = document.getElementById('mr-room-photo-bg');
            const artworkContainer = document.getElementById('mr-artwork-container');
            const artworkImg = document.getElementById('mr-artwork-img');
            const resizeHandle = document.querySelector('#my-room-mode .mr-resize-handle');
            
            const generateBtn = document.getElementById('mr-generate-btn');
            const saveBtn = document.getElementById('mr-save-btn');
            const backBtn = document.getElementById('mr-back-btn');
            const resultImage = document.getElementById('mr-result-image');

            const step1 = document.getElementById('mr-step1');
            const step2 = document.getElementById('mr-step2');
            const step3 = document.getElementById('mr-step3');
            const step4 = document.getElementById('mr-step4');

            let artworkDataUrl = null;
            let roomDataUrl = null;

            function setupDropzone(dropzone, input, onFile) {
                dropzone.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => onFile(e.target.files[0]));
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
                    dropzone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false);
                });
                ['dragenter', 'dragover'].forEach(eName => {
                    dropzone.addEventListener(eName, () => dropzone.classList.add('dragover'), false);
                });
                ['dragleave', 'drop'].forEach(eName => {
                    dropzone.addEventListener(eName, () => dropzone.classList.remove('dragover'), false);
                });
                dropzone.addEventListener('drop', (e) => onFile(e.dataTransfer.files[0]), false);
            }

            setupDropzone(artworkDropzone, artworkUpload, (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    artworkDataUrl = e.target.result;
                    artworkPreview.src = artworkDataUrl;
                    artworkPreview.classList.remove('hidden');
                    artworkDropzoneText.classList.add('hidden');
                    artworkTools.classList.remove('hidden');
                    step2.classList.remove('opacity-50', 'pointer-events-none');
                    checkIfReady();
                };
                reader.readAsDataURL(file);
            });

            setupDropzone(roomDropzone, roomUpload, (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    roomDataUrl = e.target.result;
                    roomPreview.src = roomDataUrl;
                    roomPreview.classList.remove('hidden');
                    roomDropzoneText.classList.add('hidden');
                    checkIfReady();
                };
                reader.readAsDataURL(file);
            });

            removeBgBtn.addEventListener('click', async () => {
                if (!artworkDataUrl) return;

                statusMessage.textContent = '背景を切り抜き中です...';
                statusMessage.classList.remove('text-red-500', 'text-green-600');
                statusMessage.classList.add('text-gray-500');
                removeBgBtn.disabled = true;
                const originalButtonContent = removeBgBtn.innerHTML;
                removeBgBtn.innerHTML = '<span class="spinner"></span> 処理中';

                try {
                    const base64Image = artworkDataUrl.split(',')[1];
                    const prompt = "この写真から主要な被写体（掛け軸、額、屏風など）だけを正確に切り抜き、それ以外の背景をすべて完全に透明にしてください。";
                    
                    const url = `https://ai-visual-harmony.netlify.app/.netlify/functions/generate?t=${new Date().getTime()}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            image: base64Image
                        })
                    });

                    if (!response.ok) {
                         const errorData = await response.json().catch(() => ({error: 'サーバーエラーが発生しました。'}));
                        if (errorData.error && errorData.error.includes("API key not valid")) {
                            throw new Error("Google APIで認証エラーが発生しました。<br>お手数ですが、以下の2点をご確認ください。<br>1. Netlifyの管理画面に設定したAPIキーが正しいか。<br>2. APIキーに紐付くGoogle Cloudプロジェクトの請求設定が有効になっているか。");
                        }
                        throw new Error(errorData.error);
                    }

                    const data = await response.json();

                    if (data.base64) {
                        artworkDataUrl = `data:image/png;base64,${data.base64}`;
                        artworkPreview.src = artworkDataUrl;
                        artworkImg.src = artworkDataUrl;
                        statusMessage.textContent = '背景の切り抜きが完了しました！';
                        statusMessage.classList.add('text-green-600');
                    } else {
                        throw new Error('AIから画像データが返されませんでした。');
                    }

                } catch (error) {
                    console.error("Background removal error:", error);
                    let detailedErrorMessage = error.message;
                     if (error instanceof TypeError && error.message === 'Failed to fetch') {
                        detailedErrorMessage = "サーバーとの通信に失敗しました。一時的なネットワークの問題か、サーバー側の設定が原因の可能性があります。しばらくしてから再試行してください。";
                    }
                    statusMessage.innerHTML = `エラー:<br>${detailedErrorMessage}`;
                    statusMessage.classList.add('text-red-500');
                } finally {
                    removeBgBtn.disabled = false;
                    removeBgBtn.innerHTML = originalButtonContent;
                    setTimeout(() => { statusMessage.textContent = ''; }, 7000);
                }
            });
            
            function checkIfReady() {
                if (artworkDataUrl && roomDataUrl) {
                    step1.classList.add('hidden');
                    step2.classList.add('hidden');
                    step3.classList.remove('hidden');
                    startComposition();
                }
            }
            
            function startComposition() {
                const roomImg = new Image();
                roomImg.onload = () => {
                    compositionArea.style.aspectRatio = roomImg.width / roomImg.height;
                    roomPhotoBg.src = roomDataUrl;
                    artworkImg.src = artworkDataUrl;
                };
                roomImg.src = roomDataUrl;
            }

            let isDragging = false, isResizing = false;
            let startX, startY, startLeft, startTop, startWidth, startHeight;

            artworkContainer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (e.target === resizeHandle) return;
                isDragging = true;
                startX = e.clientX; startY = e.clientY;
                startLeft = artworkContainer.offsetLeft; startTop = artworkContainer.offsetTop;
                compositionArea.style.cursor = 'grabbing';
            });
            
            resizeHandle.addEventListener('mousedown', (e) => {
                e.preventDefault(); e.stopPropagation();
                isResizing = true;
                startX = e.clientX; startY = e.clientY;
                startWidth = artworkContainer.offsetWidth; startHeight = artworkContainer.offsetHeight;
                compositionArea.style.cursor = 'se-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    artworkContainer.style.left = `${startLeft + e.clientX - startX}px`;
                    artworkContainer.style.top = `${startTop + e.clientY - startY}px`;
                } else if (isResizing) {
                    artworkContainer.style.width = `${startWidth + e.clientX - startX}px`;
                    artworkContainer.style.height = `${startHeight + e.clientY - startY}px`;
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false; isResizing = false;
                compositionArea.style.cursor = 'default';
            });
            
            function generateFinalImage(callback) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const roomImg = new Image();
                roomImg.crossOrigin = "anonymous";
                roomImg.src = roomPhotoBg.src;
                roomImg.onload = () => {
                    canvas.width = roomImg.naturalWidth; canvas.height = roomImg.naturalHeight;
                    ctx.drawImage(roomImg, 0, 0, canvas.width, canvas.height);
                    const artImg = new Image();
                    artImg.crossOrigin = "anonymous";
                    artImg.src = artworkImg.src;
                    artImg.onload = () => {
                        const compRect = compositionArea.getBoundingClientRect();
                        const artRect = artworkContainer.getBoundingClientRect();
                        const scaleX = canvas.width / compRect.width;
                        const scaleY = canvas.height / compRect.height;
                        const artX = (artRect.left - compRect.left) * scaleX;
                        const artY = (artRect.top - compRect.top) * scaleY;
                        const artWidth = artRect.width * scaleX;
                        const artHeight = artRect.height * scaleY;
                        ctx.drawImage(artImg, artX, artY, artWidth, artHeight);
                        callback(canvas.toDataURL('image/png'));
                    };
                };
            }
            
            generateBtn.addEventListener('click', () => {
                generateFinalImage((imageDataUrl) => {
                    resultImage.src = imageDataUrl;
                    step3.classList.add('hidden');
                    step4.classList.remove('hidden');
                });
            });

            saveBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = resultImage.src;
                link.download = 'my-room-simulation.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            backBtn.addEventListener('click', () => {
                step4.classList.add('hidden');
                step3.classList.remove('hidden');
            });
        }
    });
    </script>
</body>
</html>

