<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIビジュアルハーモニー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .wood-panel { background-color: #F3F2F0; } /* 和紙のような少し温かみのある白 */
        .accent-color { background-color: #FAE3D9; } /* 木目のような淡いベージュ */
        .border-accent { border-color: #D1C7B7; } /* 曖昧な境界線 */
        .btn-primary {
            background-color: #3B82F6; /* 青色 */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #2563EB; } /* 濃い青色 */
        .btn-primary:disabled {
            background-color: #93C5FD; /* 薄い青色 */
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6; /* 青色 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .step-icon {
            background-color: #3B82F6;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">AIビジュアルハーモニー</h1>
            <p class="mt-2 text-gray-600">あなたの作品はお客様のもとで映えていますか？ 確かめてみましょう</p>
        </header>

        <main class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 md:p-8 space-y-8">
            <!-- Step 1: Upload Image -->
            <div id="step1" class="flex items-start space-x-4">
                <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">1</div>
                <div>
                    <h2 class="text-xl font-bold text-gray-700">掛け軸画像をアップロード</h2>
                    <p class="text-sm text-gray-500 mb-4">背景を合成したい掛け軸の画像（背景透明PNG推奨）を選択してください。</p>
                    <div id="dropzone" class="border-2 border-dashed border-accent rounded-lg p-8 text-center cursor-pointer hover:bg-gray-50 transition">
                        <input type="file" id="imageUpload" class="hidden" accept="image/png, image/jpeg">
                        <p id="dropzone-text" class="text-gray-500">クリックしてファイルを選択<br>またはドラッグ＆ドロップ</p>
                        <img id="preview" class="hidden max-h-40 mx-auto mt-4 rounded">
                    </div>
                </div>
            </div>

            <!-- Step 2: Input Prompt -->
            <div id="step2" class="flex items-start space-x-4 opacity-50 pointer-events-none">
                <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">2</div>
                <div>
                    <h2 class="text-xl font-bold text-gray-700">背景を言葉で指示</h2>
                    <p class="text-sm text-gray-500 mb-4">どのような背景と合成したいか、具体的に入力してください。</p>
                    <textarea id="prompt" class="w-full p-3 border border-accent rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition" rows="3" placeholder="例：モダンな和室の床の間、桜が満開の縁側から見える庭"></textarea>
                    <div class="mt-4">
                        <p class="text-sm text-gray-600 mb-2">明るさの調整:</p>
                        <div class="flex space-x-2">
                             <button data-brightness="dark" class="brightness-btn flex-1 p-2 text-sm border rounded-lg transition">暗くする</button>
                             <button data-brightness="normal" class="brightness-btn flex-1 p-2 text-sm border rounded-lg transition bg-blue-100 border-blue-400 text-blue-700 font-semibold">標準</button>
                             <button data-brightness="light" class="brightness-btn flex-1 p-2 text-sm border rounded-lg transition">明るくする</button>
                        </div>
                    </div>
                    <button id="generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-105" disabled>画像を生成する</button>
                </div>
            </div>

            <!-- Step 3: Result -->
            <div id="step3" class="flex items-start space-x-4 hidden">
                <div class="step-icon text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">3</div>
                <div>
                    <h2 class="text-xl font-bold text-gray-700">生成結果</h2>
                    <div id="result-container" class="mt-4 min-h-[200px] wood-panel rounded-lg flex items-center justify-center p-4">
                        <div id="loading" class="text-center hidden">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4 text-gray-600">画像を生成中です...<br>しばらくお待ちください。</p>
                        </div>
                        <img id="resultImage" class="hidden max-w-full max-h-96 rounded-md">
                        <p id="error-message" class="text-red-500 hidden"></p>
                    </div>
                     <button id="saveBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-105 hidden">画像を保存する</button>
                </div>
            </div>
        </main>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2025 京都表具協同組合 All rights reserved.</p>
        </footer>
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const imageUpload = document.getElementById('imageUpload');
        const preview = document.getElementById('preview');
        const dropzoneText = document.getElementById('dropzone-text');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');
        const resultImage = document.getElementById('resultImage');
        const errorMessage = document.getElementById('error-message');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const saveBtn = document.getElementById('saveBtn');
        const brightnessBtns = document.querySelectorAll('.brightness-btn');

        let uploadedImageBase64 = '';
        let selectedBrightness = 'normal';

        // --- Event Listeners ---
        dropzone.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', handleFile);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('bg-gray-100'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('bg-gray-100'), false);
        });

        dropzone.addEventListener('drop', handleDrop, false);

        promptInput.addEventListener('input', () => {
            generateBtn.disabled = !(promptInput.value.trim() && uploadedImageBase64);
        });
        
        brightnessBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedBrightness = btn.dataset.brightness;
                brightnessBtns.forEach(b => b.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700', 'font-semibold'));
                btn.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700', 'font-semibold');
            });
        });

        generateBtn.addEventListener('click', generateImage);
        saveBtn.addEventListener('click', saveImage);


        // --- Functions ---
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile({ target: { files: [file] } });
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                uploadedImageBase64 = event.target.result.split(',')[1];
                preview.src = event.target.result;
                preview.classList.remove('hidden');
                dropzoneText.classList.add('hidden');
                step2.classList.remove('opacity-50', 'pointer-events-none');
                generateBtn.disabled = !promptInput.value.trim();
            };
            reader.readAsDataURL(file);
        }
        
        async function generateImage() {
            // Reset UI
            step3.classList.remove('hidden');
            loading.classList.remove('hidden');
            resultImage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            saveBtn.classList.add('hidden');
            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';
            
            let fullPrompt = promptInput.value.trim();
            if (selectedBrightness === 'dark') {
                fullPrompt += "薄暗い、落ち着いた雰囲気、影を強調";
            } else if (selectedBrightness === 'light') {
                fullPrompt += "明るい、自然光が差し込む、鮮やか";
            }
            
            try {
                // Call our Netlify Function instead of Google API directly
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: fullPrompt,
                        image: uploadedImageBase64
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `サーバーエラーが発生しました: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.base64) {
                    const imageUrl = `data:image/png;base64,${data.base64}`;
                    resultImage.src = imageUrl;
                    resultImage.classList.remove('hidden');
                    saveBtn.classList.remove('hidden');
                } else {
                    throw new Error('画像データがありません。');
                }

            } catch (error) {
                console.error("Error generating image:", error);
                errorMessage.textContent = `エラー: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = '画像を生成する';
            }
        }
        
        function saveImage() {
            const link = document.createElement('a');
            link.href = resultImage.src;
            link.download = 'ai-visual-harmony-result.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>

